#!/usr/bin/env bash -e
ROOT_DIR="$(dirname $0)/../"
source "${ROOT_DIR}/etc/settings"

help() {
  echo "$0 <file> <key> <mime_type>"
}

upload() {
  local FILE=$1
  local KEY=$2
  local MIME_TYPE=$3
  local SHA=$(shasum "${FILE}" | awk '{ print $1 }')

  local ACCOUNT_AUTHORIZATION_RESPONSE=$(
    curl \
      https://api.backblazeb2.com/b2api/v1/b2_authorize_account \
      -u "${BACKBLAZE_ACCOUNT_ID}:${BACKBLAZE_APPLICATION_KEY}" \
      2> /dev/null
  )

  local API_URL=$(echo ${ACCOUNT_AUTHORIZATION_RESPONSE} | jq -r .apiUrl)
  local ACCOUNT_AUTHORIZATION_TOKEN=$(echo ${ACCOUNT_AUTHORIZATION_RESPONSE} | jq -r .authorizationToken)
  local UPLOAD_AUTHORIZATION_RESPONSE=$(
    curl \
      -H "Authorization: ${ACCOUNT_AUTHORIZATION_TOKEN}" \
      -d '{"bucketId": "'${BACKBLAZE_MOVIE_BUCKET_ID}'"}' \
      ${API_URL}/b2api/v1/b2_get_upload_url \
      2> /dev/null
  )
  local UPLOAD_URL=$(echo ${UPLOAD_AUTHORIZATION_RESPONSE} | jq -r .uploadUrl)
  local UPLOAD_AUTHORIZATION_TOKEN=$(echo ${UPLOAD_AUTHORIZATION_RESPONSE} | jq -r .authorizationToken)

  curl                                                \
      -H "Authorization: $UPLOAD_AUTHORIZATION_TOKEN" \
      -H "X-Bz-File-Name: ${KEY}"                     \
      -H "Content-Type: ${MIME_TYPE}"                 \
      -H "X-Bz-Content-Sha1: ${SHA}"                  \
      -H "X-Bz-Info-Author: unknown"                  \
      --data-binary "@${FILE}"                        \
      ${UPLOAD_URL}
}

[[ $# -ne 2 ]] && echo "invalid arguments" && exit 1
[[ ! -f $1 ]] && echo "file not found" && exit 1

case $(echo $1 | grep -o '\..*$') in
  ".jpg")   mimetype="image/jpeg" ;;
  ".mp4")   mimetype="video/mp4" ;;
  ".json")  mimetype="application/json" ;;
  ".nfo")   mimetype="application/xml" ;;
esac

upload $@ ${mimetype}
