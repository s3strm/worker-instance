#!/usr/bin/env bash
set -e
ROOT_DIR="$(dirname $0)/../"
source "${ROOT_DIR}/etc/settings"

help() {
  echo "$0 <file> <key>"
}

upload() {
  local ACCOUNT_AUTHORIZATION_RESPONSE=$(
    curl \
      https://api.backblazeb2.com/b2api/v1/b2_authorize_account \
      -u "${BACKBLAZE_ACCOUNT_ID}:${BACKBLAZE_APPLICATION_KEY}" \
      2> /dev/null
  )

  local API_URL=$(echo ${ACCOUNT_AUTHORIZATION_RESPONSE} | jq -r .apiUrl)
  local ACCOUNT_AUTHORIZATION_TOKEN=$(echo ${ACCOUNT_AUTHORIZATION_RESPONSE} | jq -r .authorizationToken)
  local UPLOAD_AUTHORIZATION_RESPONSE=$(
    curl \
      -H "Authorization: ${ACCOUNT_AUTHORIZATION_TOKEN}" \
      -d '{"bucketId": "'${BACKBLAZE_MOVIE_BUCKET_ID}'"}' \
      ${API_URL}/b2api/v1/b2_get_upload_url \
      2> /dev/null
  )
  local UPLOAD_URL=$(echo ${UPLOAD_AUTHORIZATION_RESPONSE} | jq -r .uploadUrl)
  local UPLOAD_AUTHORIZATION_TOKEN=$(echo ${UPLOAD_AUTHORIZATION_RESPONSE} | jq -r .authorizationToken)

  curl                                                \
      -H "Authorization: $UPLOAD_AUTHORIZATION_TOKEN" \
      -H "X-Bz-File-Name: ${KEY}"                     \
      -H "Content-Type: ${MIME_TYPE}"                 \
      -H "X-Bz-Content-Sha1: ${SHA}"                  \
      -H "X-Bz-Info-Author: unknown"                  \
      --data-binary "@${FILE}"                        \
      ${UPLOAD_URL}
      2> /dev/null
}

[[ $# -ne 2 ]] && echo "invalid arguments" && exit 1
[[ ! -f $1 ]] && echo "file not found" && exit 1

FILE=$1
KEY=$2
SHA=$(shasum "${FILE}" | awk '{ print $1 }')

case $(echo ${FILE} | tr '.' '\n' | tail -n1) in
  "jpg")   MIME_TYPE="image/jpeg" ;;
  "mp4")   MIME_TYPE="video/mp4" ;;
  "json")  MIME_TYPE="application/json" ;;
  "nfo")   MIME_TYPE="application/xml" ;;
  "strm")   MIME_TYPE="application/text" ;;
esac

response=$(upload)
echo "${response}" | jq .
[[ $(echo "${response}" | jq -r .status) -ne 400 ]] || exit 1

