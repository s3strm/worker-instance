#!/usr/bin/env bash
ROOT_DIR="$(dirname $0)/../"
source "${ROOT_DIR}/etc/settings"

if [[ -z ${BACKBLAZE_ACCOUNT_AUTHORIZATION_TOKEN} ]] || [[ -z ${BACKBLAZE_API_URL} ]] ; then
  eval $(${ROOT_DIR}/bin/bb_token)
fi

IMDB_ID=$1
MOVIE_DIR=${ROOT_DIR}/outgoing/${IMDB_ID}

for f in video.mp4; do
  [[ -f "${MOVIE_DIR}/$f" ]] && continue
  mkdir -p ${MOVIE_DIR}
  wget "${BACKBLAZE_API_URL}/file/${BACKBLAZE_MOVIE_BUCKET}/${IMDB_ID}/$f?Authorization=${BACKBLAZE_ACCOUNT_AUTHORIZATION_TOKEN}" \
    -O "${MOVIE_DIR}/$f"
  [[ -s "${MOVIE_DIR}/$f" ]] || rm -f "${MOVIE_DIR}/$f"
done

make -C ${ROOT_DIR} outgoing/${IMDB_ID}/video.srt
make -C ${ROOT_DIR} outgoing/${IMDB_ID}/poster.jpg
make -C ${ROOT_DIR} outgoing/${IMDB_ID}/video.nfo

# remove directory if empty
rmdir ${MOVIE_DIR} &> /dev/null
