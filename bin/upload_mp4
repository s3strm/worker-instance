#!/usr/bin/env bash -e
ROOT_DIR="$(dirname $0)/../"
source "${ROOT_DIR}/etc/settings"

upload() {
  local FILE=$1
  local MIME_TYPE="video/mp4"
  local SHA=$(shasum "${FILE}" | awk '{ print $1 }')
  local IMDB_ID=$(basename ${FILE} .mp4)

  local ACCOUNT_AUTHORIZATION_RESPONSE=$(
    curl \
      https://api.backblazeb2.com/b2api/v1/b2_authorize_account \
      -u "${BACKBLAZE_ACCOUNT_ID}:${BACKBLAZE_APPLICATION_KEY}" \
      2> /dev/null
  )

  local API_URL=$(echo ${ACCOUNT_AUTHORIZATION_RESPONSE} | jq -r .apiUrl)
  local ACCOUNT_AUTHORIZATION_TOKEN=$(echo ${ACCOUNT_AUTHORIZATION_RESPONSE} | jq -r .authorizationToken)
  local UPLOAD_AUTHORIZATION_RESPONSE=$(
    curl \
      -H "Authorization: ${ACCOUNT_AUTHORIZATION_TOKEN}" \
      -d '{"bucketId": "'${BACKBLAZE_MOVIE_BUCKET_ID}'"}' \
      ${API_URL}/b2api/v1/b2_get_upload_url \
      2> /dev/null
  )
  local UPLOAD_URL=$(echo ${UPLOAD_AUTHORIZATION_RESPONSE} | jq -r .uploadUrl)
  local UPLOAD_AUTHORIZATION_TOKEN=$(echo ${UPLOAD_AUTHORIZATION_RESPONSE} | jq -r .authorizationToken)

  curl                                                \
      -H "Authorization: $UPLOAD_AUTHORIZATION_TOKEN" \
      -H "X-Bz-File-Name: ${IMDB_ID}/video.mp4"       \
      -H "Content-Type: ${MIME_TYPE}"                 \
      -H "X-Bz-Content-Sha1: ${SHA}"                  \
      -H "X-Bz-Info-Author: unknown"                  \
      --data-binary "@${FILE}"                        \
      ${UPLOAD_URL}
}

for f in ${INCOMING_DIR}/*.mp4; do
  upload "$f" && rm "$f"
done
